<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><script defer language=javascript type=text/javascript src=/js/bundle.min.11d62625e7495f8147fccf5d08f37bded574a50c4508c235cc666848567d99ab.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://mwtaylor.github.io/ElephantLogos/elephant_itr100.png><title itemprop=name>Elephant in the Room - Mastodon Storage Management</title><meta property="og:title" content="Elephant in the Room - Mastodon Storage Management"><meta name=twitter:title content="Elephant in the Room - Mastodon Storage Management"><meta itemprop=name content="Elephant in the Room - Mastodon Storage Management"><meta name=application-name content="Elephant in the Room - Mastodon Storage Management"><meta property="og:site_name" content="Elephant In The Room"><meta name=description content><meta itemprop=description content><meta property="og:description" content><meta name=twitter:description content><base href=https://elephantintheroom.dev/posts/mastodon-storage-management/><link rel=canonical href=https://elephantintheroom.dev/posts/mastodon-storage-management/ itemprop=url><meta name=url content="https://elephantintheroom.dev/posts/mastodon-storage-management/"><meta name=twitter:url content="https://elephantintheroom.dev/posts/mastodon-storage-management/"><meta property="og:url" content="https://elephantintheroom.dev/posts/mastodon-storage-management/"><meta property="og:updated_time" content="15009-15-09T941:58:23-0700"><link rel=sitemap type=application/xml title=Sitemap href=https://elephantintheroom.dev/sitemap.xml><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content><meta name=twitter:creator content><meta property="fb:admins" content><meta name=apple-mobile-web-app-title content="Elephant In The Room"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="15009-15-09T941:58:23-0700"><meta property="article:published_time" content="15009-15-09T941:58:23-0700"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Mastodon Storage Management","author":{"@type":"Person","name":"https:\/\/github.com\/mwtaylor\/DevelopmentBlog"},"datePublished":"2023-09-15","description":"","wordCount":"861","mainEntityOfPage":"True","dateModified":"2023-09-15","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"Elephant In The Room","logo":{"@type":"imageObject","url":"https:\/\/mwtaylor.github.io\/ElephantLogos\/elephant_itr100.png"}}}</script><meta name=generator content="Hugo 0.119.0"><link type=text/css rel=stylesheet href=/css/bundle.min.e4d2e07519de0d647d95780d40511e30cbf08ee614a8f73dd5db19838f26a412.css><style>body{--sidebar-bg-color:#202020;--sidebar-img-border-color:#515151;--sidebar-p-color:#909090;--sidebar-h1-color:#FFF;--sidebar-a-color:#FFF;--sidebar-socials-color:#FFF;--text-color:#222;--bkg-color:#FAF9F6;--post-title-color:#303030;--list-color:#5a5a5a;--link-color:#268bd2;--date-color:#515151;--table-border-color:#E5E5E5;--table-stripe-color:#F9F9F9;--code-color:#bf616a;--code-background-color:#E5E5E5;--moon-sun-color:#FFF;--moon-sun-background-color:#515151}body.dark-theme{--text-color:#eee;--bkg-color:#121212;--post-title-color:#DBE2E9;--list-color:#9d9d9d;--link-color:#268bd2;--date-color:#9a9a9a;--table-border-color:#515151;--table-stripe-color:#202020;--code-color:#ff7f7f;--code-background-color:#393D47}body{background-color:var(--bkg-color)}</style></head><body><div class=wrapper><aside class=sidebar><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class=sidebar-about><h1 class=brand><a href=https://elephantintheroom.dev/><img src=https://mwtaylor.github.io/ElephantLogos/elephant_itr400.png alt="brand image"></a>
<a href=https://elephantintheroom.dev/><h1>Elephant In The Room</h1></a></h1><p class=lead></p></div><nav><ul class=sidebar-nav><li class=heading><a href=/about/>About</a></li><li class=heading><a href=/posts/>Posts</a></li><li class=sub-heading>Recent</li><li class=bullet><a href=https://elephantintheroom.dev/posts/mastodon-storage-management/>Mastodon Storage Management</a></li><li class=bullet><a href=https://elephantintheroom.dev/posts/mastodon-basic-monitoring/>Mastodon Basic Monitoring</a></li><li class=bullet><a href=https://elephantintheroom.dev/posts/mastodon-federation/>Federating Your New Server</a></li><li class=bullet><a href=https://elephantintheroom.dev/posts/mastodon-setup/>Starting a Personal Mastodon Server</a></li></ul></nav><a target=_blank class=social title=GitHub href=https://github.com/mwtaylor/DevelopmentBlog><svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24"><path fill="currentcolor" d="M18.88 1.099C18.147.366 17.265.0 16.233.0H3.746C2.714.0 1.832.366 1.099 1.099.366 1.832.0 2.714.0 3.746v12.487c0 1.032.366 1.914 1.099 2.647.733.733 1.615 1.099 2.647 1.099H6.66c.19.0.333-.007.429-.02a.504.504.0 00.286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555.0 01-.904-.091 2.026 2.026.0 01-.872-.39 1.651 1.651.0 01-.572-.8l-.13-.3a3.25 3.25.0 00-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956.0 01-.17-.156.723.723.0 01-.117-.182c-.026-.061-.004-.111.065-.15.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1.0 01.631.677c.2.355.44.626.722.813.282.186.566.28.852.28.286.0.533-.022.742-.065a2.59 2.59.0 00.585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907.0 01-1.333-.234 5.314 5.314.0 01-1.223-.507 3.5 3.5.0 01-1.047-.872c-.277-.347-.505-.802-.683-1.365-.177-.564-.266-1.215-.266-1.952.0-1.049.342-1.942 1.027-2.68-.32-.788-.29-1.673.091-2.652.252-.079.625-.02 1.119.175.494.195.856.362 1.086.5.23.14.414.257.553.352a9.233 9.233.0 012.497-.338c.859.0 1.691.113 2.498.338l.494-.312a6.997 6.997.0 011.197-.572c.46-.174.81-.221 1.054-.143.39.98.424 1.864.103 2.653.685.737 1.028 1.63 1.028 2.68.0.737-.089 1.39-.267 1.957-.177.568-.407 1.023-.689 1.366a3.65 3.65.0 01-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9.0 01-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36.0 00.208.189c.096.034.18.056.254.064.074.01.18.013.318.013h2.914c1.032.0 1.914-.366 2.647-1.099.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/></svg></a><a target=_blank class=social rel=me title=Mastodon href=https://mwtaylor.social/@Michael><svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24"><path fill="currentcolor" d="M20.94 14c-.28 1.41-2.44 2.96-4.97 3.26-1.31.15-2.6.3-3.97.24-2.25-.11-4-.54-4-.54v.62c.32 2.22 2.22 2.35 4.03 2.42 1.82.05 3.44-.46 3.44-.46l.08 1.65s-1.28.68-3.55.81c-1.25.07-2.81-.03-4.62-.5-3.92-1.05-4.6-5.24-4.7-9.5l-.01-3.43c0-4.34 2.83-5.61 2.83-5.61C6.95 2.3 9.41 2 11.97 2h.06c2.56.0 5.02.3 6.47.96.0.0 2.83 1.27 2.83 5.61.0.0.04 3.21-.39 5.43M18 8.91c0-1.08-.3-1.91-.85-2.56-.56-.63-1.3-.96-2.23-.96-1.06.0-1.87.41-2.42 1.23l-.5.88-.5-.88c-.56-.82-1.36-1.23-2.43-1.23-.92.0-1.66.33-2.23.96C6.29 7 6 7.83 6 8.91v5.26h2.1V9.06c0-1.06.45-1.62 1.36-1.62 1 0 1.5.65 1.5 1.93v2.79h2.07V9.37c0-1.28.5-1.93 1.51-1.93.9.0 1.35.56 1.35 1.62v5.11H18V8.91z"/></svg></a><p class=footnote>powered by <a target=_blank href=https://gohugo.io>Hugo</a> | themed with <a target=_blank href=https://github.com/lukeorth/poison>poison</a><br><br><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by/4.0/88x31.png></a>
This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License</a>.</p></div></aside><main class="content container"><div class=post><div class=info><h1 class=post-title><a href=https://elephantintheroom.dev/posts/mastodon-storage-management/>Mastodon Storage Management</a></h1><time datetime=2023-09-15T21:41:58-0700 class=post-date>September 15, 2023</time><p class=seriesname>Series: <a href=https://elephantintheroom.dev/series/personal-mastodon-server>Personal Mastodon Server</a></p></div><p>We will build on the monitoring enabled by the CloudWatch agent installed in the previous post in the series. Make sure
the agent is installed and correctly running and uploading logs and metrics.</p><h1 id=create-a-disk-usage-alarm>Create a Disk Usage Alarm</h1><p>Without an alarm that your disk usage is getting high you won&rsquo;t know until your server stops responding. Recovering from
100% disk usage can be difficult, so ideally you can take action before then.</p><p>Go to the AWS CloudWatch console and view all alarms. Click on the &ldquo;Create alarm&rdquo; button.</p><h2 id=select-metric>Select Metric</h2><p>Go to the CWAgent metric namespace. Select the disk_used_percent metric for your Mastodon instance and path &ldquo;/&rdquo;. Search
all the metrics for disk_used_percent to make it easier to find. Don&rsquo;t use any metric that is not specifically for the
&ldquo;/&rdquo; path.</p><p>Verify the data in the graph looks how you expect and then click &ldquo;Select metric&rdquo;.</p><h2 id=specify-metric-and-conditions>Specify Metric and Conditions</h2><p>Set the statistic type to Average and the Period to 5 minutes.</p><p>Under conditions set the threshold type to static. Select greater and then enter the percent value you want to be
notified at. I choose 80 for my alarm.</p><p>Click &ldquo;Next&rdquo;.</p><h2 id=configure-actions>Configure Actions</h2><p>Select &ldquo;In alarm&rdquo; for the alarm state trigger. Either create the new topic &ldquo;Default_CloudWatch_Alarms_Topic&rdquo; or select
it if already existing. You can also use a different name for the topic than the AWS default.</p><p>If you created the topic enter your email address to be subscribed to receive emails for all alarms sent to this topic.
If you used a previously created topic I recommend verifying the subscription for you to receive emails for the alarms.
You will receive an email confirming your subscription to the topic and need to click the link in the email to verify.</p><p>Click &ldquo;Next&rdquo;</p><h2 id=finish-alarm>Finish Alarm</h2><p>Give your alarm a name and optionally a description. Click &ldquo;Next&rdquo;.</p><p>Verify the alarm details and when good click &ldquo;Create alarm&rdquo;.</p><h1 id=automate-cleaning-mastodon-storage>Automate Cleaning Mastodon Storage</h1><p>The previous post in this series about Mastodon Federation mentioned a tool to remove old media saved on your server
that can be safely cleaned up and fetched again as needed. This tool can be automated to run periodically to keep
your disk usage lower.</p><h2 id=run-script-using-cron>Run Script Using Cron</h2><p>Run everything in this section as the Mastodon user in the home directory.</p><p>Create the script media-remove.sh with the following contents:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>date
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Running tootctl media remove&#34;</span>
</span></span><span style=display:flex><span>cd ~/live
</span></span><span style=display:flex><span>RAILS_ENV<span style=color:#f92672>=</span>production bin/tootctl media remove --concurrency <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>date
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Complete&#34;</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&#34;</span>
</span></span></code></pre></div><p>Make sure to add execute permissions to the script.</p><p>Edit the cron file with <code>crontab -e</code> and add the line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>8</span> * * * PATH<span style=color:#f92672>=</span>$HOME/.rbenv/bin:$HOME/.rbenv/shims:$PATH $HOME/media-remove.sh &gt;&gt; /var/log/media-remove/output.log 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>This runs the script every day at 08:00 UTC. Change the time to when you expect your server to not be in use.</p><h2 id=log-the-media-remove-output>Log the Media Remove Output</h2><p>Run this section as your user that can sudo.</p><p>Create the directory media-remove in /var/log for the output of the script. Change the owner of this directory to the
<em>mastodon</em> user.</p><p>Create a file /etc/logrotate.d/media-remove to rotate the logs and add the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/var/log/media-remove/*.log <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        monthly
</span></span><span style=display:flex><span>        rotate <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span>        compress
</span></span><span style=display:flex><span>        missingok
</span></span><span style=display:flex><span>        notifempty
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Configure the CloudWatch agent to upload the &ldquo;/var/log/media-remove/output.log*&rdquo; files. Restart the agent to get the
updated config.</p><h1 id=increase-the-disk-space-of-your-instance>Increase the Disk Space of Your Instance</h1><p>If you are finding that your disk space is running low even with the media remove script running you may need to
increase the amount of disk space your instance has. 30 GB should be enough to start but if you follow a lot of users
that post a lot of images or videos you can increase as needed.</p><p>Create a snapshot of your instance first!</p><h2 id=modify-the-ebs-volume>Modify the EBS Volume</h2><p>Go to the AWS console and navigate to your EBS volume. Modify the volume to your new desired size.</p><p>When the volume modification state is &ldquo;optimizing&rdquo; or &ldquo;completed&rdquo; you can proceed.</p><h2 id=expand-the-linux-file-system>Expand the Linux File System</h2><p>After modifying the volume you must expand the file system in Linux. Follow this guide from the
<a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/recognize-expanded-volume-linux.html target=_blank>AWS Documentation</a>.</p><p>If you waited until the disk space was entirely consumed then you may get errors while expanding the file system. You
can follow this <a href=https://repost.aws/knowledge-center/ebs-volume-size-increase target=_blank>tutorial</a> to mount /tmp to a temporary file system in memory.</p><h1 id=automated-backups>Automated Backups</h1><p>AWS makes it easy to automate backing up your server. You can always manually create EBS volume snapshots as well.</p><p>If your Mastodon server has everything including the database on one server then all you need to do is backup the image
of that server. <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/snapshot-lifecycle.html target=_blank>AWS Data Lifecycle Manager</a> makes this easy to automate.</p><h2 id=setup-data-lifecycle-manager>Setup Data Lifecycle Manager</h2><p>Go to Data Lifecycle Manager in the AWS EC2 console under the Elastic Block Store navigation section and click &ldquo;Create
lifecycle policy&rdquo;. Select &ldquo;EBS-backed AMI policy&rdquo; so you will have a full machine image, and you will have the option to
reboot the server when backing up to ensure data consistency.</p><p>Follow all the prompts to set up your backups. If you don&rsquo;t have tags on your instance you can still use the Name tag
along with your instances name for the value. I set up my backups to run daily overnight and keep 3 copies.</p><hr><div class=footer><p>This is a post in the <b><a href=https://elephantintheroom.dev/series/personal-mastodon-server>Personal Mastodon Server</a></b> series.<br>Other posts in this series:<ul class=series><li>September 15, 2023 -
Mastodon Storage Management</li><li>September 15, 2023 -
<a href=/posts/mastodon-basic-monitoring/>Mastodon Basic Monitoring</a></li><li>September 12, 2023 -
<a href=/posts/mastodon-federation/>Federating Your New Server</a></li><li>September 10, 2023 -
<a href=/posts/mastodon-setup/>Starting a Personal Mastodon Server</a></li></ul></p></div></div></main><div class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#create-a-disk-usage-alarm>Create a Disk Usage Alarm</a><ul><li><a href=#select-metric>Select Metric</a></li><li><a href=#specify-metric-and-conditions>Specify Metric and Conditions</a></li><li><a href=#configure-actions>Configure Actions</a></li><li><a href=#finish-alarm>Finish Alarm</a></li></ul></li><li><a href=#automate-cleaning-mastodon-storage>Automate Cleaning Mastodon Storage</a><ul><li><a href=#run-script-using-cron>Run Script Using Cron</a></li><li><a href=#log-the-media-remove-output>Log the Media Remove Output</a></li></ul></li><li><a href=#increase-the-disk-space-of-your-instance>Increase the Disk Space of Your Instance</a><ul><li><a href=#modify-the-ebs-volume>Modify the EBS Volume</a></li><li><a href=#expand-the-linux-file-system>Expand the Linux File System</a></li></ul></li><li><a href=#automated-backups>Automated Backups</a><ul><li><a href=#setup-data-lifecycle-manager>Setup Data Lifecycle Manager</a></li></ul></li></ul></nav></div></div></div></body></html>